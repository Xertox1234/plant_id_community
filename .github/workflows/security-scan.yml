name: Security Dependency Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  backend-security:
    name: Backend Python Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install safety

      - name: Run Safety check (JSON report)
        run: |
          cd backend
          safety check --json --output safety-report.json || true
        continue-on-error: true

      - name: Run Safety check (fail on vulnerabilities)
        run: |
          cd backend
          safety check --bare
        continue-on-error: false

      - name: Upload Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: backend/safety-report.json
          retention-days: 30

      - name: Comment PR with vulnerabilities (if any)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Security vulnerabilities detected in Python dependencies**\n\nPlease check the Safety report in the workflow artifacts for details.\n\nRun locally: `cd backend && safety check`'
            })

  frontend-security:
    name: Frontend npm Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          cd web
          npm ci

      - name: Run npm audit (JSON report)
        run: |
          cd web
          npm audit --json > npm-audit-report.json || true
        continue-on-error: true

      - name: Run npm audit (fail on moderate+)
        run: |
          cd web
          npm audit --audit-level=moderate
        continue-on-error: false

      - name: Upload npm audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: web/npm-audit-report.json
          retention-days: 30

      - name: Comment PR with vulnerabilities (if any)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Security vulnerabilities detected in npm dependencies**\n\nPlease check the npm audit report in the workflow artifacts for details.\n\nRun locally: `cd web && npm audit`'
            })

  mobile-security:
    name: Flutter Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'

      - name: Get Flutter dependencies
        run: |
          cd plant_community_mobile
          flutter pub get

      - name: Check for outdated packages
        run: |
          cd plant_community_mobile
          flutter pub outdated --json > flutter-outdated.json || true
        continue-on-error: true

      - name: Upload Flutter outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-outdated-report
          path: plant_community_mobile/flutter-outdated.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [backend-security, frontend-security, mobile-security]
    if: always()

    steps:
      - name: Check scan results
        run: |
          echo "Security scan completed for all platforms"
          echo "Backend: ${{ needs.backend-security.result }}"
          echo "Frontend: ${{ needs.frontend-security.result }}"
          echo "Mobile: ${{ needs.mobile-security.result }}"

          if [[ "${{ needs.backend-security.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-security.result }}" == "failure" ]]; then
            echo "⚠️ Security vulnerabilities detected! Please review the reports."
            exit 1
          else
            echo "✅ No security vulnerabilities detected"
          fi
